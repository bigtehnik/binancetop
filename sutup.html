<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>In Play</title>
  <style>
    /* Убираем спиннеры во всех браузерах */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }

    input[type="number"] {
      -moz-appearance: textfield; /* Firefox */
    }

    /* Новый стиль для выделения символа при всех совпадениях */
    .highlight-all-symbol {
      background-color: #328ad1 !important;
      color: #000 !important;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 12px;
      background-color: #0a0a0a;
      color: #e0e0e0;
      font-size: 13px;
      line-height: 1.4;
      touch-action: manipulation;
    }

    h1 {
      color: #7b51ff;
      font-size: 1.1rem;
      margin: 0 0 12px 0;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
    }

    th,
    td {
      padding: 8px 10px;
      text-align: right;
      border-bottom: 1px solid #222;
    }

    th {
      background-color: #141414;
      color: #7b51ff;
      font-weight: 500;
      position: sticky;
      top: 0;
      backdrop-filter: blur(4px);
    }

    td:first-child,
    th:first-child {
      text-align: left;
      cursor: pointer;
      padding-left: 12px;
    }

    tr:hover {
      background-color: #1a1a1a;
    }

    .positive {
      color: #00e676;
    }

    .negative {
      color: #ff5252;
    }

    .last-update {
      font-size: 0.75rem;
      color: #888;
      text-align: right;
      margin-top: 4px;
    }

    .symbol-cell::after {
      content: '';
      opacity: 0;
      transition: opacity 0.2s;
    }

    .symbol-cell:hover::after {
      opacity: 1;
    }

    .volume-cell {
      color: #aaa;
    }

    .trades-cell {
      color: #64b5f6;
    }

    .volatility-cell {
      color: #ffab40;
    }

    .correlation-cell {
      color: #ba68c8;
    }

    .high-activity,
    .high-volatility,
    .low-correlation,
    .high-volume,
    .high-change {
      background-color: rgba(29, 233, 182, 0.2);
    }

    @keyframes flash {
      0% { background-color: rgba(123, 81, 255, 0); }
      50% { background-color: rgba(123, 81, 255, 0.3); }
      100% { background-color: rgba(123, 81, 255, 0); }
    }

    .flash-effect {
      animation: flash 0.5s ease-out;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      overflow: hidden;
      opacity: 0;
      transition: opacity 0.3s ease;
      touch-action: none;
    }

    .modal.show {
      opacity: 1;
    }

    .modal-content {
      background-color: #1a1a1a;
      margin: 20px auto;
      padding: 0;
      border: 1px solid #333;
      width: 90%;
      max-width: 500px;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
      transform: translateY(-20px);
      transition: transform 0.3s ease;
      display: flex;
      flex-direction: column;
      max-height: 90vh;
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      z-index: 101;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #333;
      background-color: #1a1a1a;
      cursor: move;
      user-select: none;
    }

    .modal-title {
      color: #7b51ff;
      font-size: 1.2rem;
      margin: 0;
    }

    .close-modal {
      color: #aaa;
      font-size: 1.5rem;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      margin-left: 15px;
    }

    .close-modal:hover {
      color: #fff;
    }

    .modal-body {
      padding: 0 20px;
      overflow-y: auto;
      flex-grow: 1;
      scrollbar-width: none;
    }

    .modal-body::-webkit-scrollbar {
      display: none;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid #333;
      background-color: #1a1a1a;
      display: flex;
      justify-content: flex-end;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #bbb;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      background-color: #222;
      border: 1px solid #333;
      border-radius: 4px;
      color: #fff;
      font-family: inherit;
      -webkit-appearance: none;
      appearance: none;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .settings-btn {
      background: none;
      border: none;
      color: #7b51ff;
      font-size: 1.2rem;
      cursor: pointer;
      padding: 0 8px;
    }

    .save-btn {
      background-color: #7b51ff;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
    }

    .save-btn:hover {
      background-color: #6a40e0;
    }

    .input-hint {
      font-size: 0.75rem;
      color: #666;
      margin-top: 4px;
    }

    @media (max-width: 480px) {
      .modal-content {
        width: 95%;
        margin: 10px auto;
        max-height: 85vh;
      }

      .modal-header,
      .modal-body,
      .modal-footer {
        padding: 12px 15px;
      }

      .modal-title {
        font-size: 1.1rem;
      }

      .form-group {
        margin-bottom: 12px;
      }
    }
  </style>
</head>
<body>
  <h1><button class="settings-btn" id="settingsBtn">▢</button></h1>

  <table id="quotesTable">
    <thead>
      <tr>
        <th>Symbol</th>
        <th>24h %</th>
        <th>Vol</th>
        <th>Volot</th>
        <th>Trades</th>
        <th>Corr</th>
      </tr>
    </thead>
    <tbody id="quotesBody"></tbody>
  </table>

  <div id="lastUpdate" class="last-update">Loading...</div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content" id="modalContent">
      <div class="modal-header" id="modalHeader">
        <h2 class="modal-title">Settings</h2>
        <button class="close-modal" id="closeModalBtn">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="minVolume">Min Volume</label>
          <input type="text" id="minVolume" placeholder="50M">
          <div class="input-hint">Example: 50M = 50,000,000</div>
        </div>
        <div class="form-group">
          <label for="refreshInterval">Refresh (sec)</label>
          <input type="number" id="refreshInterval" placeholder="20">
        </div>
        <div class="form-group">
          <label for="maxRows">Max Rows</label>
          <input type="number" id="maxRows" placeholder="20">
        </div>
        <div class="form-group">
          <label for="excludedSymbols">Excluded</label>
          <textarea id="excludedSymbols" placeholder="ALPACAUSDT,BNXUSDT,OCEANUSDT,AGIXUSDT"></textarea>
        </div>
        <div class="form-group">
          <label for="volumeThreshold">Volume Threshold</label>
          <input type="text" id="volumeThreshold" placeholder="250M">
          <div class="input-hint">Example: 250M = 250,000,000</div>
        </div>
        <div class="form-group">
          <label for="tradesThreshold">Trades Threshold</label>
          <input type="text" id="tradesThreshold" placeholder="100K">
          <div class="input-hint">Example: 100K = 100,000</div>
        </div>
        <div class="form-group">
          <label for="volatilityThreshold">Volatility Threshold</label>
          <input type="number" step="0.1" id="volatilityThreshold" placeholder="2.5">
        </div>
        <div class="form-group">
          <label for="changeThreshold">Change Threshold (%)</label>
          <input type="number" id="changeThreshold" placeholder="15">
        </div>
        <div class="form-group">
          <label for="correlationThreshold">BTC Correlation (%)</label>
          <input type="number" id="correlationThreshold" placeholder="30">
        </div>
      </div>
      <div class="modal-footer">
        <button class="save-btn" id="saveSettings">Save</button>
      </div>
    </div>
  </div>

  <script>
    let config = {
      minVolume: 50000000,
      volumeThreshold: 250000000,
      refreshInterval: 20000,
      maxRows: 20,
      excludedSymbols: ['ALPACAUSDT', 'BNXUSDT', 'OCEANUSDT', 'AGIXUSDT'],
      tradesThreshold: 100000,
      volatilityThreshold: 2.5,
      changeThreshold: 15,
      correlationThreshold: 30
    };
    let updateInterval;
    let isLoading = false;
    const quotesBody = document.getElementById('quotesBody');
    const lastUpdateEl = document.getElementById('lastUpdate');
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsModal = document.getElementById('settingsModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const saveSettingsBtn = document.getElementById('saveSettings');
    const modalContent = document.getElementById('modalContent');
    const modalHeader = document.getElementById('modalHeader');

    function formatPercent(value) {
      const num = parseFloat(value);
      return num > 0 ? `+${num.toFixed(2)}%` : `${num.toFixed(2)}%`;
    }

    function formatVolume(value) {
      const num = parseFloat(value);
      if (num >= 1000000000) return `${(num / 1000000000).toFixed(1)}B`;
      return `${(num / 1000000).toFixed(1)}M`;
    }

    function formatTrades(value) {
      const num = parseInt(value);
      if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
      if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
      return num.toString();
    }

    function numberWithSpaces(x) {
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    function parseHumanNumber(value) {
      if (typeof value === 'number') return value;
      if (typeof value !== 'string') return 0;
      const str = value.trim().toUpperCase().replace(/\s+/g, '');
      if (!str) return 0;
      if (!isNaN(str)) return parseFloat(str);
      const numPart = parseFloat(str.replace(/[^0-9.]/g, ''));
      const suffix = str.replace(/[0-9.]/g, '').trim();
      switch(suffix) {
        case 'K': return numPart * 1000;
        case 'M': return numPart * 1000000;
        case 'B': return numPart * 1000000000;
        default: return numPart;
      }
    }

    function loadConfig() {
      const savedConfig = localStorage.getItem('binanceAnalyticsConfig');
      if (savedConfig) {
        try {
          const parsedConfig = JSON.parse(savedConfig);
          config = {...config, ...parsedConfig};
        } catch (e) {
          console.error('Error reading config', e);
        }
      }
    }

    function saveConfig() {
      localStorage.setItem('binanceAnalyticsConfig', JSON.stringify(config));
    }

    async function calculateCorrelation(symbol) {
      try {
        const [symbolRes, btcRes] = await Promise.all([
          fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1m&limit=60`),
          fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1m&limit=60`)
        ]);
        const [symbolData, btcData] = await Promise.all([symbolRes.json(), btcRes.json()]);
        const symbolPrices = symbolData.map(k => parseFloat(k[4]));
        const btcPrices = btcData.map(k => parseFloat(k[4]));
        const symbolReturns = [], btcReturns = [];
        for (let i = 1; i < symbolPrices.length; i++) {
          symbolReturns.push((symbolPrices[i] - symbolPrices[i - 1]) / symbolPrices[i - 1]);
          btcReturns.push((btcPrices[i] - btcPrices[i - 1]) / btcPrices[i - 1]);
        }
        return pearsonCorrelation(symbolReturns, btcReturns) * 100;
      } catch (error) {
        console.error(`Error fetching correlation for ${symbol}:`, error);
        return 0;
      }
    }

    function pearsonCorrelation(x, y) {
      const n = x.length;
      if (n !== y.length || n === 0) return 0;
      let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
      for (let i = 0; i < n; i++) {
        sumX += x[i];
        sumY += y[i];
        sumXY += x[i] * y[i];
        sumX2 += x[i] * x[i];
        sumY2 += y[i] * y[i];
      }
      const numerator = sumXY - (sumX * sumY / n);
      const denominator = Math.sqrt((sumX2 - sumX*sumX/n) * (sumY2 - sumY*sumY/n));
      return denominator === 0 ? 0 : numerator / denominator;
    }

    async function calculateVolatility(symbol) {
      try {
        const res = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1h&limit=14`);
        const data = await res.json();
        if (!data || data.length < 14) return 0;
        let sumTR = 0;
        for (let i = 1; i < data.length; i++) {
          const high = parseFloat(data[i][2]);
          const low = parseFloat(data[i][3]);
          const prevClose = parseFloat(data[i - 1][4]);
          sumTR += Math.max(
            high - low,
            Math.abs(high - prevClose),
            Math.abs(low - prevClose)
          );
        }
        const atr = sumTR / 14;
        const lastPrice = parseFloat(data[data.length - 1][4]);
        return lastPrice ? (atr / lastPrice) * 100 : 0;
      } catch (error) {
        console.error(`Error fetching volatility for ${symbol}:`, error);
        return 0;
      }
    }

    async function fetchData() {
      if (isLoading) return;
      isLoading = true;
      try {
        const res = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
        const data = await res.json();
        const filteredPairs = data
          .filter(item => 
            item.symbol.endsWith('USDT') &&
            parseFloat(item.quoteVolume) >= config.minVolume &&
            !config.excludedSymbols.includes(item.symbol) &&
            item.symbol !== 'BTCUSDT'
          )
          .sort((a, b) => parseFloat(b.priceChangePercent) - parseFloat(a.priceChangePercent))
          .slice(0, config.maxRows);
        const pairsWithMetrics = await Promise.all(filteredPairs.map(async pair => {
          const [volatility, correlation] = await Promise.all([
            calculateVolatility(pair.symbol),
            calculateCorrelation(pair.symbol)
          ]);
          return { ...pair, volatility, correlation };
        }));
        updateTable(pairsWithMetrics);
        updateLastUpdateTime();
      } catch (error) {
        console.error('Error loading data:', error);
        lastUpdateEl.textContent = 'Error loading data';
      } finally {
        isLoading = false;
      }
    }

    function updateTable(pairs) {
      quotesBody.innerHTML = '';
      pairs.forEach(pair => {
        const changePercent = parseFloat(pair.priceChangePercent);
        const isHighChange = Math.abs(changePercent) >= config.changeThreshold;
        const isHighVolume = parseFloat(pair.quoteVolume) >= config.volumeThreshold;
        const isHighTrades = pair.count >= config.tradesThreshold;
        const isHighVolatility = pair.volatility >= config.volatilityThreshold;
        const isLowCorrelation = Math.abs(pair.correlation) < config.correlationThreshold;
        const allHighlightsTriggered = isHighChange && isHighVolume && isHighTrades && isHighVolatility && isLowCorrelation;
        const changeClass = changePercent >= 0 ? 'positive' : 'negative';
        const symbolCellClass = allHighlightsTriggered ? 'symbol-cell highlight-all-symbol' : 'symbol-cell';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="${symbolCellClass}" title="Click to copy">${pair.symbol}</td>
          <td class="${changeClass} ${isHighChange ? 'high-change' : ''}">${formatPercent(pair.priceChangePercent)}</td>
          <td class="volume-cell ${isHighVolume ? 'high-volume' : ''}">${formatVolume(pair.quoteVolume)}</td>
          <td class="volatility-cell ${isHighVolatility ? 'high-volatility' : ''}">${pair.volatility.toFixed(2)}%</td>
          <td class="trades-cell ${isHighTrades ? 'high-activity' : ''}">${formatTrades(pair.count)}</td>
          <td class="correlation-cell ${isLowCorrelation ? 'low-correlation' : ''}">${pair.correlation.toFixed(2)}%</td>
        `;
        const symbolCell = row.querySelector('.symbol-cell');
        symbolCell.addEventListener('click', () => {
          navigator.clipboard.writeText(pair.symbol).catch(err => console.error('Copy failed:', err));
          row.classList.add('flash-effect');
          setTimeout(() => row.classList.remove('flash-effect'), 500);
        });
        quotesBody.appendChild(row);
      });
    }

    function updateLastUpdateTime() {
      const now = new Date();
      lastUpdateEl.textContent = `Last Update: ${now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' })}`;
    }

    // --- [Настройки модального окна] ---
    function initSettingsModal() {
      settingsBtn.addEventListener('click', () => {
        document.getElementById('minVolume').value = numberWithSpaces(parseInt(config.minVolume));
        document.getElementById('volumeThreshold').value = numberWithSpaces(parseInt(config.volumeThreshold));
        document.getElementById('tradesThreshold').value = numberWithSpaces(parseInt(config.tradesThreshold));
        document.getElementById('refreshInterval').value = config.refreshInterval / 1000;
        document.getElementById('maxRows').value = config.maxRows;
        document.getElementById('excludedSymbols').value = config.excludedSymbols.join(',');
        document.getElementById('volatilityThreshold').value = config.volatilityThreshold;
        document.getElementById('changeThreshold').value = config.changeThreshold;
        document.getElementById('correlationThreshold').value = config.correlationThreshold;
        resetModalPosition();
        settingsModal.style.display = 'block';
        setTimeout(() => settingsModal.classList.add('show'), 10);
      });

      function closeModalFunc() {
        settingsModal.classList.remove('show');
        setTimeout(() => settingsModal.style.display = 'none', 300);
      }

      closeModalBtn.addEventListener('click', closeModalFunc);

      window.addEventListener('click', (e) => {
        if (e.target === settingsModal && !isDragging) closeModalFunc();
      });

      saveSettingsBtn.addEventListener('click', () => {
        config.minVolume = parseHumanNumber(document.getElementById('minVolume').value) || 50000000;
        config.volumeThreshold = parseHumanNumber(document.getElementById('volumeThreshold').value) || 250000000;
        config.tradesThreshold = parseHumanNumber(document.getElementById('tradesThreshold').value) || 100000;
        config.refreshInterval = (parseInt(document.getElementById('refreshInterval').value) || 20) * 1000;
        config.maxRows = parseInt(document.getElementById('maxRows').value) || 20;
        config.excludedSymbols = document.getElementById('excludedSymbols').value
          .split(',')
          .map(s => s.trim().toUpperCase())
          .filter(Boolean);
        config.volatilityThreshold = parseFloat(document.getElementById('volatilityThreshold').value) || 2.5;
        config.changeThreshold = parseFloat(document.getElementById('changeThreshold').value) || 15;
        config.correlationThreshold = parseFloat(document.getElementById('correlationThreshold').value) || 30;
        saveConfig();
        closeModalFunc();
        clearInterval(updateInterval);
        updateInterval = setInterval(fetchData, config.refreshInterval);
        fetchData();
      });
    }

    // --- [Перетаскивание модального окна] ---
    let isDragging = false;
    let startX, startY, startLeft, startTop;

    function initDrag() {
      modalHeader.addEventListener('mousedown', startDrag);
      modalHeader.addEventListener('touchstart', startDrag);

      function startDrag(e) {
        e.preventDefault();
        isDragging = true;
        const rect = modalContent.getBoundingClientRect();
        startLeft = rect.left;
        startTop = rect.top;
        if (e.type === 'mousedown') {
          startX = e.clientX;
          startY = e.clientY;
          document.addEventListener('mousemove', drag);
          document.addEventListener('mouseup', stopDrag);
        } else {
          startX = e.touches[0].clientX;
          startY = e.touches[0].clientY;
          document.addEventListener('touchmove', drag);
          document.addEventListener('touchend', stopDrag);
        }
      }

      function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        const clientX = e.touches?.[0]?.clientX || e.clientX;
        const clientY = e.touches?.[0]?.clientY || e.clientY;
        const newLeft = startLeft + (clientX - startX);
        const newTop = startTop + (clientY - startY);
        modalContent.style.left = `${newLeft}px`;
        modalContent.style.top = `${newTop}px`;
        modalContent.style.position = 'fixed';
        modalContent.style.transform = 'none';
      }

      function stopDrag() {
        isDragging = false;
        document.removeEventListener('mousemove', drag);
        document.removeEventListener('mouseup', stopDrag);
        document.removeEventListener('touchmove', drag);
        document.removeEventListener('touchend', stopDrag);
      }
    }

    function resetModalPosition() {
      modalContent.style.left = '';
      modalContent.style.top = '';
      modalContent.style.position = '';
      modalContent.style.transform = '';
    }

    // --- [Инициализация] ---
    document.addEventListener('DOMContentLoaded', () => {
      loadConfig();
      initSettingsModal();
      initDrag();
      fetchData();
      updateInterval = setInterval(fetchData, config.refreshInterval);
    });

    window.addEventListener('beforeunload', () => {
      clearInterval(updateInterval);
    });

    // --- [Форматирование чисел с пробелами] ---
    document.querySelectorAll('input[type="text"]').forEach(input => {
      input.addEventListener('input', () => {
        const rawValue = input.value.replace(/\D/g, '');
        input.value = numberWithSpaces(rawValue);
      });
    });
  </script>
</body>
</html>
